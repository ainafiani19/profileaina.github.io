<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAP</title>

    <!-- MAPLIBRE -->
    <script src="https://unpkg.com/maplibre-gl@^5.8.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@^5.8.0/dist/maplibre-gl.css" rel="stylesheet" />

    <!-- TAILWIND -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class"
        }
    </script>
    <!--CDN TAILWIN CSS-->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!--CDN Turf.js-->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>

    <!-- Tambahkan AlpineJS biar dropdown bisa klik-buka -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>


</head>

<body class=" min-h-screen w-full bg-[#F5F9E9]">

    <!-- NAVBAR -->
    <nav class="w-1full flex flex-wrap items-center justify-between gap-4 
    bg-[#475b63] dark:bg-[#24322E]
    text-[#F5F9E9] dark:text-[#E9EFE5]
    px-4 py-2 sticky top-0 z-10">

        <div class="flex items-center gap-3">
            <a href="/Final Project/coding/Home_Page.html" id="home"
                class="p-2 bg-[#345995] dark:bg-[#2E5A94] rounded hover:bg-[#57A773] dark:hover:bg-[#4CAF74] transition active:scale-95">
                <img src="assets/home-svgrepo-com.svg" class="w-5 h-5 invert brightness-0">
            </a>

            <div class="text-base font-bold flex items-center gap-1 cursor-pointer">
                MyWebGIS
            </div>
        </div>

        <form id="formKecamatan" class="flex flex-wrap items-center gap-4 w-full md:w-auto">

            <!-- Pilih Kecamatan -->
            <div class="flex items-center gap-2">
                <label for="kecamatan" class="font-semibold text-[#F5F9E9] whitespace-nowrap">
                    Pilih Kecamatan:
                </label>
                <select name="kecamatan" id="kecamatan"
                    class="text-black bg-white px-3 py-2 rounded shadow-sm border border-gray-300 focus:ring-2 focus:ring-[#57A773] focus:border-[#57A773]">
                    <option value="">SEMUA KECAMATAN</option>
                    <option value="BABELAN">BABELAN</option>
                    <option value="BOJONGMANGU">BOJONGMANGU</option>
                    <option value="CABANGBUNGIN">CABANGBUNGIN</option>
                    <option value="CIBARUSAH">CIBARUSAH</option>
                    <option value="CIBITUNG">CIBITUNG</option>
                    <option value="CIKARANG BARAT">CIKARANG BARAT</option>
                    <option value="CIKARANG PUSAT">CIKARANG PUSAT</option>
                    <option value="CIKARANG SELATAN">CIKARANG SELATAN</option>
                    <option value="CIKARANG TIMUR">CIKARANG TIMUR</option>
                    <option value="CIKARANG UTARA">CIKARANG UTARA</option>
                    <option value="KARANG BAHAGIA">KARANG BAHAGIA</option>
                    <option value="KEDUNG WARINGIN">KEDUNG WARINGIN</option>
                    <option value="MUARA GEMBONG">MUARA GEMBONG</option>
                    <option value="PEBAYURAN">PEBAYURAN</option>
                    <option value="SERANG BARU">SERANG BARU</option>
                    <option value="SETU">SETU</option>
                    <option value="SUKAKARYA">SUKAKARYA</option>
                    <option value="SUKATANI">SUKATANI</option>
                    <option value="SUKAWANGI">SUKAWANGI</option>
                    <option value="TAMBELANG">TAMBELANG</option>
                    <option value="TAMBUN SELATAN">TAMBUN SELATAN</option>
                    <option value="TAMBUN UTARA">TAMBUN UTARA</option>
                    <option value="TARUMAJAYA">TARUMAJAYA</option>
                </select>
            </div>


            <!-- Layer Checkbox Custom -->
            <div class="relative inline-block w-56" x-data="{ open: false }">
                <div class="border border-gray-300 bg-white text-black px-3 py-2 rounded shadow-sm cursor-pointer select-none hover:border-[#57A773]"
                    @click="open = !open">
                    Pilih Layer
                </div>

                <div x-show="open"
                    class="absolute mt-1 w-full bg-white border border-gray-300 rounded shadow-md p-2 z-10 max-h-48 overflow-y-auto">
                    <label class="flex items-center gap-2 py-1 px-2 hover:bg-gray-100 text-black">
                        <input type="checkbox" value="Properti" class="accent-[#57A773]"> Properti
                    </label>
                    <label class="flex items-center gap-2 py-1 px-2 hover:bg-gray-100 text-black">
                        <input type="checkbox" value="Pendidikan" class="accent-[#57A773]"> Pendidikan
                    </label>
                    <label class="flex items-center gap-2 py-1 px-2 hover:bg-gray-100 text-black">
                        <input type="checkbox" value="Kesehatan" class="accent-[#57A773]"> Kesehatan
                    </label>
                    <label class="flex items-center gap-2 py-1 px-2 hover:bg-gray-100 text-black">
                        <input type="checkbox" value="Transportasi" class="accent-[#57A773]"> Transportasi
                    </label>
                    <label class="flex items-center gap-2 py-1 px-2 hover:bg-gray-100 text-black">
                        <input type="checkbox" value="Banjir" class="accent-[#57A773]"> Kebencanaan
                    </label>
                </div>
            </div>

            <input type="submit" value="Submit"
                class="px-4 py-2 bg-[#57A773] text-white rounded shadow-md hover:bg-[#4CAF74] active:scale-95 cursor-pointer">
        </form>

        <div id="tools" class="flex flex-wrap items-center gap-2 w-full md:w-auto justify-end">
            <button id="layer-variabel"
                class="p-2 bg-[#345995] dark:bg-[#2E5A94] rounded hover:bg-[#57A773] dark:hover:bg-[#4CAF74] transition active:scale-95">
                <img src="assets/layer-svgrepo-com.svg" class="w-5 h-5 invert brightness-0">
            </button>

            <!-- portofilio page belum muncul-->
            <a href="/Potofolio_Page.html" id="contact-us"
                class="p-2 bg-[#345995] dark:bg-[#2E5A94] rounded hover:bg-[#57A773] dark:hover:bg-[#4CAF74] transition active:scale-95">
                <img src="assets/contact-svgrepo-com.svg" class="w-5 h-5 invert brightness-0">
            </a>

            <button id="mode"
                class="p-2 bg-[#345995] dark:bg-[#2E5A94] rounded hover:bg-[#57A773] dark:hover:bg-[#4CAF74] transition active:scale-95">
                <img src="assets/mode-dark-svgrepo-com.svg" class="w-5 h-5 invert brightness-0">
            </button>
        </div>
    </nav>
    <!--MAP-->
    <div id="map" class="w-full h-[calc(100vh-60px)] bg-[#157145] dark:bg-[#13201C]"></div>


    <script>

        //1. script untuk switch mode
        const LIGHT = "https://basemap.mapid.io/styles/street-2d-building/style.json?key=68dcd62806823ed3f510dddf";
        const DARK = "https://basemap.mapid.io/styles/dark/style.json?key=68dcd62806823ed3f510dddf";


        if (localStorage.theme === "dark") {
            document.documentElement.classList.add("dark");
        } else {
            document.documentElement.classList.remove("dark");
            localStorage.theme = "light";
        }

        function changeTheme() {
            if (document.documentElement.classList.contains("dark")) {
                document.documentElement.classList.remove("dark")
                localStorage.theme = "light"
                map.setStyle(lightStyle)
            } else {
                document.documentElement.classList.add("dark")
                localStorage.theme = "dark"
                map.setStyle(darkStyle)
            }
        }
        document.getElementById("mode").addEventListener("click", changeTheme);

        //2. Script memanggil peta
        // Theme
        const MAP_SERVICE_KEY = "68dcd62806823ed3f510dddf";
        const LIGHT_THEME = "street-2d-building";
        const DARK_THEME = "dark";
        const lightStyle = `https://basemap.mapid.io/styles/${LIGHT_THEME}/style.json?key=${MAP_SERVICE_KEY}`;
        const darkStyle = `https://basemap.mapid.io/styles/${DARK_THEME}/style.json?key=${MAP_SERVICE_KEY}`;
        const initialStyle = localStorage.theme === "dark" ? darkStyle : lightStyle;

        if (localStorage.theme === "dark") {
            document.documentElement.classList.add("dark");
        } else {
            localStorage.theme = "light";
        }

        function changeTheme() {
            if (document.documentElement.classList.contains("dark")) {
                document.documentElement.classList.remove("dark");
                localStorage.theme = "light";
                map.setStyle(lightStyle);
            } else {
                document.documentElement.classList.add("dark");
                localStorage.theme = "dark";
                map.setStyle(darkStyle);
            }
        }
        document.getElementById("mode").addEventListener("click", changeTheme);

        // Init map
        const map = new maplibregl.Map({
            style: initialStyle,
            center: [107.14504645971738, -6.255886768288434],
            zoom: 10,
            container: "map"
        });

        // URLs
        const kecUrl = "https://geoserver.mapid.io/layers_new/get_layer?api_key=5249521c14de436ebcf1fb8f05e6048d&layer_id=68fe2517c8804625c62c5477&project_id=68f488c244612b4d22ec2f83&limit=10000";

        const pointLayerSources = {
            Properti: "https://geoserver.mapid.io/layers_new/get_layer?api_key=5249521c14de436ebcf1fb8f05e6048d&layer_id=68fb8f3a96b90db738e31ad5&project_id=68f488c244612b4d22ec2f83&limit=10000",
            Pendidikan: "https://geoserver.mapid.io/layers_new/get_layer?api_key=5249521c14de436ebcf1fb8f05e6048d&layer_id=68fb8f99c8804625c613cd3c&project_id=68f488c244612b4d22ec2f83&limit=10000",
            Kesehatan: "https://geoserver.mapid.io/layers_new/get_layer?api_key=5249521c14de436ebcf1fb8f05e6048d&layer_id=68fb8f6096b90db738e31ee9&project_id=68f488c244612b4d22ec2f83&limit=10000",
            Transportasi: "https://geoserver.mapid.io/layers_new/get_layer?api_key=5249521c14de436ebcf1fb8f05e6048d&layer_id=68fb8f75c8804625c613cc1b&project_id=68f488c244612b4d22ec2f83&limit=10000",
            Banjir: "https://geoserver.mapid.io/layers_new/get_layer?api_key=5249521c14de436ebcf1fb8f05e6048d&layer_id=68fb8fbec8804625c613d261&project_id=68f488c244612b4d22ec2f83&limit=10000",
        };

        // Icons
        const icons = {
            Properti: 'assets/properti.png',
            Pendidikan: 'assets/sekolah.png',
            Kesehatan: 'assets/hospital.png',
            Transportasi: 'assets/stasiun.png',
            Banjir: 'assets/pintu.png'
        };

        // Load polygon & icons
        map.on("load", () => {
            map.addSource("Kecamatan", { type: "geojson", data: kecUrl });

            map.addLayer({
                id: "Kecamatan-layer",
                type: "fill",
                source: "Kecamatan",
                paint: { "fill-color": "grey", "fill-opacity": 0.4 }
            });

            Object.entries(icons).forEach(([name, url]) => {
                map.loadImage(url, (err, img) => {
                    if (err) return;
                    if (!map.hasImage(name)) map.addImage(name, img);
                });
            });
        });

        map.on("styledata", () => {
            if (!map.getSource("Kecamatan")) {
                map.addSource("Kecamatan", { type: "geojson", data: kecUrl });
                map.addLayer({
                    id: "Kecamatan-layer",
                    type: "fill",
                    source: "Kecamatan",
                    paint: { "fill-color": "grey", "fill-opacity": 0.4 }
                });
            }

            Object.entries(icons).forEach(([name, url]) => {
                if (!map.hasImage(name)) {
                    map.loadImage(url, (err, img) => {
                        if (!err) map.addImage(name, img);
                    });
                }
            });
        });

        // Handle submit
        document.getElementById('formKecamatan').addEventListener('submit', async (e) => {
            e.preventDefault();

            const kec = document.getElementById('kecamatan').value;
            const checked = [...document.querySelectorAll('input[type=checkbox]:checked')]
                .map(cb => cb.value);

            // Fit boundary if kec selected
            if (!kec) {
                map.setFilter("Kecamatan-layer", null);
                map.fitBounds([[106.8, -6.7], [107.4, -6.05]], { padding: 40 });
            } else {
                map.setFilter("Kecamatan-layer", ["==", ["get", "KECAMATAN"], kec]);
                const data = await (await fetch(kecUrl)).json();
                const fitur = data.features.filter(f => f.properties.KECAMATAN === kec);

                if (fitur.length > 0) {
                    const bbox = turf.bbox(fitur[0]);
                    map.fitBounds(bbox, { padding: 40, maxZoom: 13 });
                }
            }

            // Clear old point layers
            Object.keys(pointLayerSources).forEach(id => {
                if (map.getLayer(id)) map.removeLayer(id);
                if (map.getSource(id)) map.removeSource(id);
            });

            // Add new point layers
            for (const layerName of checked) {
                const res = await fetch(pointLayerSources[layerName]);
                const data = await res.json();

                let filteredData = data;
                if (kec) {
                    filteredData = {
                        type: "FeatureCollection",
                        features: data.features.filter(f => f.properties.KECAMATAN === kec)
                    };
                }

                map.addSource(layerName, { type: "geojson", data: filteredData });
                map.addLayer({
                    id: layerName,
                    type: "symbol",
                    source: layerName,
                    layout: {
                        "icon-image": layerName,
                        "icon-size": 0.9,
                        "icon-allow-overlap": true
                    }
                });
            }
        });


    </script>


</body>


</html>